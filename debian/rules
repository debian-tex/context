#! /usr/bin/make -f

package        := context
# zipfiles       := cont-tmf.zip cont-fnt.zip cont-ext.zip cont-img.zip
instbase       := debian/$(package)

include /usr/share/dpatch/dpatch.make

build: build-indep

# unpack-stamp:
# 	for i in $(zipfiles) ; do unzip $$i ; done
# 	touch unpack-stamp

# patch-stamp: unpack-stamp


build-indep: build-indep-stamp

build-indep-stamp: patch-stamp
	touch build-indep-stamp

clean: unpatch
	dh_testroot
	rm -f build-indep-stamp
	# rm -rf bibtex context doc fonts metapost scripts tex tpm web2c
	dh_clean

test-nonfree:
	found=0 ; for i in $$(cat debian/MANIFEST.nonfree debian/MANIFEST.doc-nonfree) ; do	\
		if [ -r $$i ] ; then			\
			echo "nonfree stuff: $$i"	;	\
			found=1;	\
		fi ;					\
	done ; 	if [ $$found = 1 ] ; then	\
		echo "Found non free stuff, stopping, please clean up first!" ;\
		exit 1;	\
	fi

binary-indep: build-indep test-nonfree
	dh_testdir 
	dh_testroot
	dh_clean
	dh_installdirs usr/share/texmf usr/share/doc/$(package)	\
		var/lib/texmf/web2c/pdfetex
	cp -a scripts bibtex context fonts metapost tex web2c 	\
		$(instbase)/usr/share/texmf
	# this file is not needed
	rm $(instbase)/usr/share/texmf/web2c/context.cnf
	# switch to ruby
	#rm -r $(instbase)/usr/share/texmf/scripts/context/ruby
	rm -r $(instbase)/usr/share/texmf/scripts/context/stubs
	#we still need the perl scripts
	#rm -r $(instbase)/usr/share/texmf/scripts/context/perl
	rm -r $(instbase)/usr/share/texmf/context/examplap
	rm -r $(instbase)/usr/share/texmf/fonts/map/dvipdfm

	# we need a check here that all maps are installed
	# use context.formats and context.maps in debian dir
	dh_installtex
	
	dh_installdirs usr/bin etc/texmf/context/config

	# install our context-format creation script
	cp debian/ctxfmtutil $(instbase)/usr/bin
	# and the formats definitions
	cp debian/formats.cnf $(instbase)/etc/texmf/context/config

	# switch to ruby
	cp scripts/context/stubs/unix/* $(instbase)/usr/bin
	cp debian/texmfstart $(instbase)/usr/bin
	# missing stubs for some perl scripts:
	cp -a debian/stubs/* $(instbase)/usr/bin/

	# documentation
	cp -a doc/context/* $(instbase)/usr/share/doc/$(package)
	cp -a doc/fonts $(instbase)/usr/share/doc/$(package)
	rm $(instbase)/usr/share/doc/$(package)/scripts/perl/texshow.1
	dh_installman				\
		doc/context/scripts/perl/texshow.1		\
		debian/manpages/*.man

	dh_installdocs debian/changelog.Debian.prerelease	\
			debian/MANIFEST.nonfree	debian/MANIFEST.doc-nonfree

	# backward compatibility with pdftex < 1.40 where formats MUST
	# be put into web2c/pdfetex, while new context puts them into
	# web2c/pdftex
	# There is also a preinst part to this problem
	# This can be removed as soon as TeX Live 2006/7 is in Debian
	# Then also the link should be removed
	dh_link var/lib/texmf/web2c/pdfetex var/lib/texmf/web2c/pdftex

	# lintian override for script-not-executable
	install -D --mode=644 debian/override $(instbase)/usr/share/lintian/overrides/$(package)

	dh_installchangelogs
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_gencontrol
	dh_md5sums
	dh_builddeb

binary-arch:
# We have nothing to do here but the Debian Policy says this target must
# exist.

binary: binary-indep binary-arch

.PHONY: clean build build-indep binary binary-indep binary-arch
